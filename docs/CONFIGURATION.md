# Configuring ld-find-code-refs 

`ld-find-code-refs` may be configured using [command line flags](#command-line), [environment variables](#environment-variables), or a [YAML file](#yaml).

If options are defined multiple times across configuration methods, they will be used with the following priority:

flags > env > yaml

In addition, [ignore files](#ignoring-files-and-directories) may be defined to improve performance and exclude files and directories from being scanned by `ld-find-code-refs`.

## Required arguments

The following arguments are required to run `ld-find-code-refs`. For a detailed description of all options, see the [command line arguments](#command-line)

| Option        | Description                                                                                                                                                                                                                                    |
| ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `accessToken` | LaunchDarkly [personal access token](https://docs.launchdarkly.com/docs/api-access-tokens) with writer-level access, or access to the `code-reference-repository` [custom role](https://docs.launchdarkly.com/v2.0/docs/custom-roles) resource |
| `dir`         | Path to existing checkout of the git repo. The currently checked out branch will be scanned for code references.                                                                                                                               |
| `projKey`     | A LaunchDarkly project key.                                                                                                                                                                                                                    |
| `repoName`    | Git repo name. Will be displayed in LaunchDarkly. Repo names must only contain letters, numbers, '.', '\_' or '-'.                                                                                                                            |

## Command line

<!-- These docs should be autogenerated: https://github.com/spf13/cobra/blob/master/doc/md_docs.md -->
Usage:
```
ld-find-code-refs [flags]
```

Flags:

```
  -t, --accessToken string         LaunchDarkly personal access token with write-level access.

  -U, --baseUri string             LaunchDarkly base URI. (default "https://app.launchdarkly.com")

  -b, --branch string              The currently checked out git branch. If not provided, branch name will be auto-detected. Provide this option when using CI systems that leave the repository in a detached HEAD state.

      --commitUrlTemplate string   If provided, LaunchDarkly will attempt to generate links to your Git service provider per commit. Example: https://github.com/launchdarkly/ld-find-code-refs/commit/${sha}. Allowed template variables: 'branchName', 'sha'. If commitUrlTemplate is not provided, but repoUrl is provided and repoType is not custom, LaunchDarkly will automatically generate links to the repository for each commit.

  -c, --contextLines int           The number of context lines to send to LaunchDarkly. If < 0, no source code will be sent to LaunchDarkly. If 0, only the lines containing flag references will be sent. If > 0, will send that number of context lines above and below the flag reference. A maximum of 5 context lines may be provided. (default 2)
      --debug                      Enables verbose debug logging

  -B, --defaultBranch string       The git default branch. The LaunchDarkly UI will default to this branch. If not provided, will fallback to 'master'. (default "master")

  -d, --dir string                 Path to existing checkout of the git repo.
      --dryRun                     If enabled, the scanner will run without sending code references to LaunchDarkly. Combine with the outDir option to output code references to a CSV.

  -h, --help                       help for ld-find-code-refs
      --hunkUrlTemplate string     If provided, LaunchDarkly will attempt to generate links to  your Git service provider per code reference.  Example: https://github.com/launchdarkly/ld-find-code-refs/blob/${sha}/${filePath}#L${lineNumber}. Allowed template variables: 'sha', 'filePath', 'lineNumber'. If hunkUrlTemplate is not provided,  but repoUrl is provided and repoType is not custom, LaunchDarkly will automatically generate links to the repository for each code reference.

  -i, --ignoreServiceErrors        If enabled, the scanner will terminate with exit code 0 when the LaunchDarkly API is unreachable or returns an unexpected response.

  -o, --outDir string              If provided, will output a csv file containing all code references for the project to this directory.

  -p, --projKey string             LaunchDarkly project key.

  -r, --repoName string            Git repo name. Will be displayed in LaunchDarkly. Case insensitive. Repo names must only contain letters, numbers, '.', '_' or '-'."

  -T, --repoType string            The repo service provider. Used to correctly categorize repositories in the LaunchDarkly UI. Aceptable values: github|bitbucket|custom. (default "custom")

  -u, --repoUrl string             The display url for the repository. If provided for a github or bitbucket repository, LaunchDarkly will attempt to automatically generate source code links.

  -s, --updateSequenceId int       An integer representing the order number of code reference updates. Used to version updates across concurrent executions of the flag finder. If not provided, data will always be updated. If provided, data will only be updated if the existing "updateSequenceId" is less than the new "updateSequenceId". Examples: the time a "git push" was initiated, CI build number, the current unix timestamp. (default -1)
```

## Environment variables

All command line flags are available as environment variables following the "upper snake case" format, with a prefix of `LD_`. For example, the command line option `accessToken` may be set as an environment variable e.g. `export LD_ACCESS_TOKEN = 'myTestToken'`.  

## YAML

A YAML file may be used to specify most command line arguments, as well as a number of additional options for advanced usage of `ld-find-code-refs`. The configuration YAML file should be stored as `${dir}/.launchdarkly/coderefs.yaml`.

Command line options translate directly to keys in your YAML file. For example, the following options in [this example](EXAMPLES.md#context-lines) can be specified in YAML as follows:

```yaml
projKey: my-project
repoName: my-repo
contextLines: 3
```

### YAML Restrictions

`accessToken` and `dir` may not be specified in the YAML file, and must be specified as either command line flags or environment variables.

### Advanced YAML configuration

In addition to all command line options, the `coderefs.yaml` file allows you to configure Code Reference Aliases and custom flag key delimiters.

#### Aliases

Patterns to match aliases for your flag keys may be defined to better suit your implementation of LaunchDarkly. See [ALIASES.md](ALIASES.md) for more information.

#### Delimiters

By default, `ld-find-code-refs` will only match flag keys surrounded by single quotes ('), double quotes ("), or backticks (`). This default behavior may be disabled and additional delimiters may be defined to better suit your implementation of LaunchDarkly.

The following example disables delimiters, and instructs `ld-find-code-refs` to only match flag keys surrounded by carets (< and >)

```yaml
delimiters:
  disableDefaults: true # boolean. if enabled, only `additional` delimiters will be used.
  additional:           # an array of single-character strings
    - '<'
    - '>'
```

## Ignoring files and directories

All dotfiles and patterns in `.gitignore` and `.ignore` will be excluded by default.

To ignore additional files and directories, provide a `.ldignore` file in the root directory of your Git repository. All patterns specified in `.ldignore` file will be excluded by the scanner. Patterns must follow the `.gitignore` format as specified here: https://git-scm.com/docs/gitignore#_pattern_format
